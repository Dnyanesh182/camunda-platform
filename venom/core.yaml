name: Test core functionality of Camunda Platform

# Uppercase vars are provided as Venom env vars.
vars:
  releaseName: '{{ .RELEASE_NAME | default "integration" }}'

testcases:

# https://docs.camunda.io/docs/self-managed/identity/user-guide/generating-m2m-tokens/
- name: tasklist
  steps:
  - name: tasklist step
    type: http
    range:
    - component: Tasklist
      clientID: tasklist
      clientSecret: "XALaRPl5qwTEItdwCMiPS62nVpKs7dL7"
    method: POST
    url: "http://localhost:18080/auth/realms/camunda-platform/protocol/openid-connect/token"
    headers:
      Content-Type: application/x-www-form-urlencoded
    body: |-
      client_id={{ .value.clientID }}&client_secret={{ .value.clientSecret }}&grant_type=client_credentials
    info: |
      Component: {{ .value.component }}
      - Request Body: {{ .result.request.body }}
      - Response Body: {{ .result.body }}
      - Response Error (if any): {{ .result.err }}
    assertions:
    - result.statuscode ShouldEqual 200
    vars:
      oauth2token:
        from: result.bodyjson.access_token
        default: bad
- name: Using m2m token
  steps:
  - name: "{{ .value.component }}-2"
    type: http
    range:
    - component: Tasklist
      clientID: tasklist
      oauth2_token: "{{.tasklist.oauth2token}}"
    method: POST
    headers:
      Authorization: "Bearer {{.value.oauth2_token}}"
      Accept: "application/json"
    url: "http://localhost:8082/v1/tasks/search"
    info: |
      Component: {{ .value.component }}
      - Request Body: {{ .result.request.body }}
      - Response Body: {{ .result.body }}
      - Response Error (if any): {{ .result.err }}

